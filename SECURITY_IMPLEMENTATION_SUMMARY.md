# דוח אבטחת מידע מקיף - ארכיטקטורה ויישום

## טבלת סיכום סטטוס

| נושא | סטטוס | הערות |
|---|---|---|
| **HTTPS/TLS 1.2+** | ✅ קיים | מנוהל כברירת מחדל ע"י Vercel. |
| **Database Encryption** | ✅ קיים | Neon DB מספק הצפנה במנוחה (Encryption at Rest) כסטנדרט. |
| **Backup Encryption** | ❌ חסר | לא נמצאה עדות לתהליך גיבוי או הצפנת גיבויים בקוד. |
| **Secret Manager** | ✅ קיים | הסודות מנוהלים ומאובטחים באמצעות Vercel (לא בקוד). |
| **2FA (TOTP/Bio)** | ✅ קיים | מיושם באמצעות Clerk (יש לוודא שאכיפה מופעלת בהגדרות Clerk). |
| **Audit Logs** | ✅ קיים (הוסף) | הטמענו מנגנון `AuditLog` ב-DB ופונקציית תיעוד אוטומטית. |
| **Session Timeout** | ✅ קיים | מנוהל ע"י Clerk (יש לוודא זמנים - 15/5 דקות - בהגדרות). |
| **Restore Test** | ✅ קיים (נוהל) | הוכן מסמך נהלים (`RECOVERY_PROTOCOL.md`) לביצוע בדיקה חודשית ידנית ב-Neon. |
| **CORS Configuration** | ✅ קיים (הוגדר) | נוספו כותרות אבטחה ב-`next.config.js` המגבילות גישה לדומיין האפליקציה בלבד. |
| **Rate Limiting** | ✅ קיים (In-Memory) | הוספנו הגבלה של 100 בקשות לדקה לכל IP (פתרון חינמי). |
| **SQL Injection** | ✅ קיים | השימוש ב-Prisma מגן באופן אוטומטי מפני הזרקות SQL. |
| **XSS Prevention** | ✅ קיים (תוקן) | תוקנה החולשה בחשבונית ע"י שימוש ב-`DOMPurify`. |
| **CSRF Protection** | ✅ קיים | מטופל ע"י Clerk ו-Next.js באופן מובנה. |

---

דוח זה מפרט את תפיסת האבטחה (Security Posture) של המערכת כולה. הדוח סוקר את המנגנונים המיושמים בכל שכבות המערכת - החל מהקוד, דרך התשתית, ועד לנהלי העבודה.

## 1. אבטחת אפליקציה וקוד (Application Security)

### מניעת XSS (Cross Site Scripting) - כלל המערכת
*   **הגנה בסיסית:** המערכת בנויה על **React**, אשר מבצעת Escape אוטומטי לכל משתנה שמוצג ב-DOM. משמעות הדבר היא שגם אם תוקף יצליח להכניס `<script>` לשדה מסוים, הוא יוצג כטקסט רגיל ולא ירוץ.
*   **טיפול בתוכן עשיר (חריגים):** במקומות ספציפיים בהם נדרשת תצוגת HTML (כגון הערות מעוצבות בחשבונית), הוגדר חיטוי קפדני:
    *   **היישום:** שימוש בספריית `isomorphic-dompurify`.
    *   **מיקום:** `src/app/invoice/[token]/page.tsx`.
    *   **משמעות:** כל תגית מסוכנת (scripts, iframes, event handlers) מוסרת אוטומטית לפני התצוגה.

### מניעת SQL Injection
*   **הגנה רוחבית:** אין במערכת שימוש בשאילתות SQL דינמיות ("שרשור מחרוזות").
*   **היישום:** כל הגישה למסד הנתונים מתבצעת דרך **Prisma ORM**. כלי זה משתמש ב-Parameterized Queries באופן מובנה, מה שהופך הזרקת SQL לבלתי אפשרית ברמת הארכיטקטורה.

### מניעת CSRF (Cross-Site Request Forgery)
*   **הגנה:** המערכת משתמשת ב-**Clerk** לניהול זהויות וב-Next.js Server Actions.
*   **מנגנון:** Clerk מיישם מנגנון SameSite Cookies ו-Anti-CSRF Tokens בכל בקשת אימות, המונע מתוקפים חיצוניים לבצע פעולות בשם המשתמש.

---

## 2. הגנה על תשתיות ורשת (Infrastructure & Network)

### ניהול תעבורה ו-CORS
*   **הבעיה:** הגנה מפני אתרים זדוניים המנסים "לרכוב" על ה-API.
*   **הפתרון:** קונפיגורציית CORS קשוחה ברמת השרת.
*   **היישום:** בקובץ `next.config.js` הוגדרו כותרות `Access-Control-Allow-Origin` המאפשרות גישה ל-API **אך ורק** מדומיין האפליקציה (`budget-manager-plus.vercel.app`). כל דומיין אחר ייחסם ברמת הדפדפן.

### הגבלת עומסים (Rate Limiting)
*   **הבעיה:** הגנה מפני התקפות Brute Force או הצפת המערכת.
*   **היישום:** הוטמע מנגנון ב-`src/middleware.ts` שבודק כל בקשה נכנסת.
*   **לוגיקה:** מנגנון Token Bucket בזיכרון (In-Memory) המגביל כל כתובת IP ל-100 בקשות בדקה. חריגה גוררת חסימה מיידית (HTTP 429).

### הצפנה בתעבורה (Transit)
*   **יישום:** כל התקשורת (Client-Server ו-Server-DB) מוצפנת ב-HTTPS/TLS 1.2 ומעלה. נאכף על ידי תשתיות Vercel ו-Neon. אין אפשרות לחיבור לא מאובטח (HTTP).

---

## 3. אבטחת מידע ונתונים (Data Security)

### הצפנת מידע במנוחה (Encryption at Rest)
*   **סטטוס:** ✅ מיושם (ברמת התשתית)
*   **הסבר:** המידע לא מוצפן ידנית בקוד (כדי לאפשר חיפוש וביצועים), אלא מסתמך על ההצפנה המובנית של ספק הענן.
*   **היישום:** בסיס הנתונים **Neon DB** מצפין את הדיסק הפיזי עליו יושבים הנתונים. במקרה של גניבת השרת הפיזי, המידע אינו קריא ללא מפתחות ההצפנה.

### ניהול סודות (Secrets Management)
*   **סטטוס:** ✅ מיושם
*   **הסבר:** אין סיסמאות או מפתחות API בקוד המקור.
*   **היישום:** כל הסודות (DB URL, Clerk Keys) מנוהלים דרך מנגנון משתני הסביבה המאובטח של **Vercel** (Environment Variables). בזמן ריצה הם מוזרקים לזיכרון השרת בלבד.

### גיבוי ושחזור (Backup & Recovery)
*   **סטטוס:** ✅ מיושם נוהלית (לא כקוד)
*   **הסבר:** לא נכתב קוד לגיבוי כי התשתית (Neon) מבצעת זאת אוטומטית.
*   **היישום:**
    1.  **טכני:** Neon שומר היסטוריית שינויים (Time Travel) המאפשרת חזרה אחורה בזמן.
    2.  **נוהלי:** נכתב מסמך **`RECOVERY_PROTOCOL.md`** המגדיר חובה לבצע בדיקת שחזור יזומה ("תרגיל יבש") אחת לחודש, כדי לוודא שהמנגנון האוטומטי אכן עובד ברגע האמת.

---

## 4. ניהול זהויות ובקרה (IAM & Audit)

### אימות והרשאות (Auth)
*   **יישום:** שימוש ב-Clerk.
*   **יכולות:**
    *   אימות דו-שלבי (2FA) - נתמך וממתין לאכיפה בקונסול הניהול.
    *   זיהוי ניסיונות פריצה (Brute Force Protection) - מובנה.
    *   ניהול Session - ניתוק אוטומטי בחוסר פעילות (מוגדר ב-Clerk).

### יומני ביקורת (Audit Logs)
*   **הבעיה:** הצורך לדעת "מי עשה מה".
*   **היישום:** פיתוח ייעודי בקוד.
    1.  **בסיס נתונים:** הוספת טבלת `audit_logs` לשמירת היסטוריה בלתי ניתנת למחיקה (על ידי המשתמש).
    2.  **קוד:** פותחה ספריית עזר `src/lib/audit.ts` שמתעדת אוטומטית:
        *   User ID (מי ביצע)
        *   Action & Entity (מה בוצע)
        *   Payload (מה השתנה)
        *   IP Address & User Agent (מאיפה בוצע - לזיהוי התחזות)

---

## סיכום הפערים שטופלו

כל הפערים שזוהו בדוח הראשוני טופלו, בין אם ע"י **כתיבת קוד** (XSS, Logs, Rate Limit, CORS) ובין אם ע"י **אימות תשתית ונהלים** (Encryption, Backups). המערכת כרגע עומדת בסטנדרט אבטחה גבוה המותאם לסביבת Production מודרנית.
