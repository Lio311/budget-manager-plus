generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// Enums for Business Support
enum PlanType {
  PERSONAL
  BUSINESS
}

enum VatType {
  NONE            // Ptor (Eilat etc.)
  FULL            // 100% recognized
  PARTIAL         // 2/3 or other %
  EXEMPT          // Frugality, etc.
}

model User {
  id        String   @id 
  email     String   @unique
  city      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
   
  budgets    Budget[]
  categories Category[]
  subscriptions Subscription[]
  businessProfile BusinessProfile?
  paymentHistory PaymentHistory[]
  feedbacks    Feedback[]
  clients    Client[]
  suppliers  Supplier[]
  invoices   Invoice[]
  quotes     Quote[]
  creditNotes    CreditNote[]
  userPaymentMethods UserPaymentMethod[]
  workEvents WorkEvent[]
  storedReports StoredReport[]
  createdTasks ProjectTask[]
  marketingCampaigns MarketingCampaign[]
  businessExpenses   BusinessExpense[]
  managementNotifications ManagementNotification[]
  agreement  EmployeeAgreement?

  initialBalance Float @default(0) 
  initialSavings Float @default(0) 
  businessInitialBalance Float @default(0)
  businessInitialSavings Float @default(0) 
  
  // Trial period
  trialEndsAt    DateTime?
  hasUsedTrial   Boolean  @default(false)

  // Onboarding
  hasSeenOnboarding Boolean  @default(false)

  // Google Calendar Integration
  googleCalendarRefreshToken String?
  googleCalendarId           String?
  isCalendarSyncEnabled      Boolean   @default(false)

  // Referral Program
  referralCode          String?   @unique // The code this user shares
  referredByCode        String?   // The code this user used when verifying (optional tracking)
  referralCount         Int       @default(0) // Successful referrals
  referralProgramActive Boolean   @default(false) // Opted-in status
  referralCoupons       Coupon[]  @relation("UserReferralCoupons") // Derived coupons

  // Integrations
  shortcutApiKey        String?   @unique

  @@map("users")
}

model BusinessProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String
  companyId   String?  // H.P. / Osek Murshe
  vatStatus   String   // EXEMPT (Ptor), AUTHORIZED (Murshe), LTD (Baam)
  logoUrl     String?  // URL to company logo
  logoPublicId String? // Cloudinary public ID for deletion
  address     String?  // Business address
  phone       String?  // Business phone
  email       String?  // Business email
  signatureUrl String? // Digital signature (base64)
  taxRate     Float    @default(0) // Income Tax Rate %
  marketingBudget Float @default(0) // Total Marketing Budget
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("business_profiles")
}

// ... (previous enums)

enum BudgetType {
  PERSONAL
  BUSINESS
}

// ... (User/BusinessProfile models remain same)

model Budget {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month     Int      
  year      Int      
  type      BudgetType @default(PERSONAL) // NEW: Supports separating Personal/Business budgets
  currency  String   @default("₪")
  incomes   Income[]
  expenses  Expense[]
  bills     Bill[]
  debts     Debt[]
  savings   Saving[]
  categoryBudgets CategoryBudget[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  initialBalance Float? // Monthly override for starting balance
  initialSavings Float? // Monthly override for starting savings
  
  // CHANGED: Unique constraint now includes 'type' to allow 2 budgets per month (Personal + Business)
  @@unique([userId, month, year, type])
  @@index([userId, month, year])
  @@map("budgets")
}

model Category {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  type      String   // income, expense, saving
  scope     BudgetType @default(PERSONAL) // NEW: Category belongs to Personal or Business view
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // ... (Relation to CategoryBudget)
  categoryBudgets CategoryBudget[]
  
  @@unique([userId, name, type, scope])
  @@map("categories")
}

model CategoryBudget {
  id        String   @id @default(cuid())
  budgetId  String
  budget    Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  categoryId String
  category  Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  limit     Float    @default(0) // The user-defined limit amount
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([budgetId, categoryId])
  @@map("category_budgets")
}


// SMB Enums
enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  BIT
  OTHER
}

enum ExpenseType {
  OPEX // Operational Expenditure
  CAPEX // Capital Expenditure (Assets)
}



model UserPaymentMethod {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
  @@map("user_payment_methods")
}


model Income {
  id                String   @id @default(cuid())
  budgetId          String
  budget            Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  source            String
  category          String   @default("כללי")
  amount            Float
  date              DateTime?
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?
  
  // Business Fields
  clientId          String?
  client            Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  invoiceId         String?
  invoice           Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  amountBeforeVat   Float?
  vatRate           Float?   @default(0) // 0.17 etc.
  vatAmount         Float?
  invoiceDate       DateTime? // Tax event date
  paymentDate       DateTime? // Cash flow date (actual payment)
  paymentMethod     String?   // Changed from Enum to String for flexibility
  paymentTerms      Int?     @default(0)
  payer             String?   // NEW: Who paid this income
  workTime          String?   // NEW: Optional Work Time
  acceptedBy        String?   // NEW: Optional Accepted By
  currency          String   @default("ILS")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@index([budgetId])
  @@index([clientId])
  workEvents WorkEvent[]
  @@map("incomes")
}

model Expense {
  id                String   @id @default(cuid())
  budgetId          String
  budget            Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category          String
  amount            Float
  currency          String   @default("ILS")
  description       String?
  date              DateTime?
  installments      Int      @default(1)
  currentInstallment Int     @default(1)
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?
  
  // Business Fields
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  expenseType       ExpenseType? @default(OPEX)
  amountBeforeVat   Float?
  vatRate           Float?   @default(0) // 0.17 etc.
  vatAmount         Float?
  vatType           VatType? @default(FULL)
  isDeductible      Boolean? @default(true) // For income tax recognition
  deductibleRate    Float?   @default(1.0) // 1.0 = 100%, 0.45 = 45% etc.

  invoiceDate       DateTime? // Tax event date
  paymentDate       DateTime? // Cash flow date
  paymentMethod     String?    // Changed from Enum to String for flexibility
  paymentTerms      Int?     @default(0)
  

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@index([budgetId])
  @@index([budgetId, category])
  @@index([supplierId])
  @@map("expenses")
}

model Bill {
  id          String   @id @default(cuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  name        String
  amount      Float
  currency    String   @default("ILS")
  dueDate     DateTime @default(now())
  isPaid      Boolean  @default(false)
  category    String   @default("חשבונות")
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  paidDate            DateTime?
  paymentMethod       String?   // NEW
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([budgetId])
  @@index([budgetId, isPaid])
  @@map("bills")
}

model Debt {
  id              String    @id @default(cuid())
  budgetId        String
  budget          Budget    @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  creditor        String
  debtType        String    // owed_by_me, owed_to_me
  totalAmount     Float
  currency        String    @default("ILS")
  monthlyPayment  Float
  dueDay          Int
  isPaid          Boolean   @default(false)
  isRecurring     Boolean   @default(false)
  recurringSourceId String?
  totalDebtAmount Float?    // For installments tracking
  numberOfInstallments Int?
  installmentNumber Int?
  paidDate        DateTime?
  paymentMethod   String?   // NEW
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@index([budgetId])
  @@index([budgetId, isPaid])
  @@map("debts")
}

model Saving {
  id              String    @id @default(cuid())
  budgetId        String?
  budget          Budget?   @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  name            String    @default("חסכון")
  targetAmount    Float?
  currentAmount   Float     @default(0)
  currency        String    @default("ILS")
  monthlyDeposit  Float?    // Planned monthly contribution
  targetDate      DateTime?
  category        String    @default("חסכון") // e.g., Emergency Fund, Vacation
  color           String?   // UI color integration
  notes           String?
  paymentMethod   String?   // NEW
  
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@map("savings")
}

model Subscription {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status            String    @default("inactive") // trial, active, expired, inactive
  planType          PlanType  @default(PERSONAL)   // NEW: PERSONAL vs BUSINESS
  couponCode        String?   // Tracks which coupon was used (for Admin display)
  startDate         DateTime  @default(now())
  endDate           DateTime?
  paypalOrderId     String?
  lastPaymentDate   DateTime?
  lastPaymentAmount Float?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  expiryNotified30Days Boolean @default(false)
  expiryNotified7Days  Boolean @default(false)
  deletionScheduledFor DateTime?
  
  @@unique([userId, planType]) // CHANGED: Allow one subscription per plan type
  @@map("subscriptions")
}

model PaymentHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  currency      String   @default("ILS")
  status        String   // completed, failed, pending
  paypalOrderId String?
  createdAt     DateTime @default(now())
  @@map("payment_history")
}

model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique
  discountPercent Float
  expiryDate      DateTime?
  maxUses         Int?
  usedCount       Int       @default(0)
  specificEmail   String?   // Optional: restrict to specific user email
  planType        PlanType? // Optional: restrict to specific plan (PERSONAL/BUSINESS)
  
  // Referral Reward Link
  ownerId         String? 
  owner           User?    @relation("UserReferralCoupons", fields: [ownerId], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@map("coupons")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())
  
  @@map("feedbacks")
}

model TrialTracker {
  id        String   @id @default(cuid())
  email     String
  planType  PlanType @default(PERSONAL)
  createdAt DateTime @default(now())

  @@unique([email, planType])
  @@map("trial_trackers")
}

model SiteConfig {
  id              String   @id @default("default")
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt

  @@map("site_config")
}

model AIAdviceCache {
  id        String   @id @default(cuid())
  userId    String
  month     Int
  year      Int
  advice    String   @db.Text
  createdAt DateTime @default(now())
  expiresAt DateTime
  
  @@unique([userId, month, year])
  @@index([userId, expiresAt])
  @@map("ai_advice_cache")
}

model StoredReport {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  year      Int
  type      String   // e.g., "BKMVDATA", "PDF_REF"
  data      String   @db.Text // The actual content (or reference)
  fileName  String?  // Suggested filename
  createdAt DateTime @default(now())

  @@index([userId, year, type])
  @@map("stored_reports")
}

model SiteSettings {
  id              String   @id @default("site_settings")
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt
  
  @@map("site_settings")
}

// Business Models

model Client {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Client details
  name      String
  email     String?
  phone     String?
  taxId     String?  // ח.פ / ע.מ
  address   String?
  notes     String?  @db.Text
  
  // SaaS / Subscription Fields
  subscriptionType   String?   // WEEKLY, MONTHLY, YEARLY
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  subscriptionPrice  Float?
  subscriptionStatus String?   // PAID, UNPAID, PARTIAL, INSTALLMENTS
  packageName        String?
  eventLocation      String?  // Physical location of service (optional)
  
  // Metadata
  scope     String   @default("BUSINESS")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  incomes   Income[]
  invoices  Invoice[]
  quotes    Quote[]
  workEvents WorkEvent[]
  
  @@index([userId, scope])
  @@unique([userId, name, scope])
  @@map("clients")
}

model Supplier {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Supplier details
  name      String
  email     String?
  phone     String?
  taxId     String?  // ח.פ / ע.מ
  address   String?
  notes     String?  @db.Text
  
  // Metadata
  scope     String   @default("BUSINESS")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  expenses  Expense[]
  
  @@index([userId, scope])
  @@unique([userId, name, scope])
  @@map("suppliers")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  SIGNED
}

model Invoice {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Invoice details
  invoiceNumber String
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  status        InvoiceStatus @default(DRAFT)
  
  // Amounts
  subtotal      Float
  vatRate       Float         @default(0.18)
  vatAmount     Float
  total         Float
  currency      String        @default("ILS")
  paymentMethod String?       // NEW: User selected payment method
  
  // Payment
  paidDate      DateTime?
  paidAmount    Float?
  
  // Notes
  notes         String?       @db.Text
  
  // Metadata
  scope         String        @default("BUSINESS")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Digital Signing (Green Invoice)
  token         String?       @unique @default(cuid()) // For public access
  signature     String?       // Base64 encoded signature
  documentHash  String?       // SHA-256 Hash
  signedAt      DateTime?
  isSigned      Boolean       @default(false)
  
  // Relations
  incomes       Income[]
  lineItems     InvoiceLineItem[]
  creditNotes   CreditNote[] // NEW
  
  @@index([userId, scope])
  @@index([clientId])
  @@unique([userId, invoiceNumber])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Float    @default(1)
  price       Float
  total       Float    // quantity * price
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([invoiceId])
  @@map("invoice_line_items")
}
enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Quote {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Quote details
  quoteNumber   String
  issueDate     DateTime    @default(now())
  validUntil    DateTime?
  status        QuoteStatus @default(DRAFT)
  
  // Amounts
  subtotal      Float
  vatRate       Float       @default(0.18)
  vatAmount     Float
  total         Float
  currency      String      @default("₪")
  
  // Line Items
  items         Json?       // Stores array of { description, quantity, price, total }
  
  // Notes
  notes         String?     @db.Text
  
  // Metadata
  scope         String      @default("BUSINESS")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Digital Signing (Public View)
  token         String?     @unique @default(cuid()) // For public access
  signature     String?     // Base64 encoded signature
  signedAt      DateTime?
  isSigned      Boolean     @default(false)

  @@index([userId, scope])
  @@index([clientId])
  @@unique([userId, quoteNumber])
  @@map("quotes")
}

model CreditNote {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reference to original invoice
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  
  // Credit Note details
  creditNoteNumber String
  issueDate       DateTime @default(now())
  
  // Amounts (can be partial or full credit)
  creditAmount    Float    // Amount being credited (before VAT)
  vatAmount       Float
  totalCredit     Float    // Total including VAT
  
  // Reason/Notes
  reason          String?  @db.Text
  
  // Digital Signing
  documentHash    String?  // SHA-256 Hash
  signedAt        DateTime?

  // Metadata
  scope           String   @default("BUSINESS")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Public viewing (no signature needed from client)
  token           String?  @unique @default(cuid())
  
  @@index([userId, scope])
  @@index([invoiceId])
  @@unique([userId, creditNoteNumber])
  @@map("credit_notes")
}
// ... (existing content)

model WorkEvent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  start       DateTime
  end         DateTime?
  allDay      Boolean  @default(false)
  location    String?
  
  // Relations
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  
  incomeId    String?
  income      Income?  @relation(fields: [incomeId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, start])
  @@map("work_events")
}

// Management Dashboard Enums & Models

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  STUCK
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Department {
  DEV
  SECURITY
  QA
  MARKETING
  BIZ_DEV
}

model ProjectTask {
  id          String      @id @default(cuid())
  title       String
  description String?      @db.Text
  status      TaskStatus  @default(TODO)
  priority    Priority    @default(MEDIUM)
  department  Department
  
  assignees   String[]
  
  dueDate     DateTime?
  
  createdBy   String
  creator     User        @relation(fields: [createdBy], references: [id])
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  completedAt DateTime?
  
  @@index([department])

  @@index([status])
  @@map("project_tasks")
}

model MarketingCampaign {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  type        String   // e.g. PPC, Collaboration, Social
  status      String   @default("ACTIVE") // ACTIVE, PAUSED, ENDED
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  startDate   DateTime?
  endDate     DateTime?
  
  cost        Float?    // Budget/Cost
  currency    String    @default("ILS")
  paymentMethod String?
  paymentFrequency String? // "ONE_TIME", "MONTHLY"
  
  notes       String?   @db.Text
  
  // Relations
//   expenses    Expense[] // REMOVED relation to main Expense
  expenses    BusinessExpense[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@map("marketing_campaigns")
}

model EmployeeAgreement {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  version      Int      @default(1)
  status       String   @default("SIGNED") 
  signature    String?  @db.Text // base64
  signedAt     DateTime @default(now())
  
  filledValues Json?    // Stores the inputs user filled
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("employee_agreements")
}

model VisitorLog {
  id        String   @id @default(uuid())
  city      String
  country   String?
  createdAt DateTime @default(now())

  @@index([city])
  @@index([createdAt])
  @@map("visitor_logs")
}


model BusinessExpense {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  description String   @map("title") // Map description to title to match the column name or just rename field
  amount      Float
  currency    String   @default("ILS")
  date        DateTime @default(now())
  
  category    String   @default("General") // Marketing, Hosting, etc.
  
  // Relation to Campaign
  campaignId  String?  @map("marketingCampaignId")
  campaign    MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  paymentMethod String?
  notes       String?  @db.Text
  
  responsibles String[] @default(["RON"])

  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([campaignId])
  @@map("business_expenses")
}

model ManagementNotification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // TASK_CREATED, TASK_STATUS_CHANGED, CAMPAIGN_CREATED, EXPENSE_CREATED
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("management_notifications")
}
