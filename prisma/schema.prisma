generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// Enums for Business Support
enum PlanType {
  PERSONAL
  BUSINESS
}

enum VatType {
  NONE            // Ptor (Eilat etc.)
  FULL            // 100% recognized
  PARTIAL         // 2/3 or other %
  EXEMPT          // Frugality, etc.
}

model User {
  id        String   @id 
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
   
  budgets    Budget[]
  categories Category[]
  subscriptions Subscription[]
  businessProfile BusinessProfile?
  paymentHistory PaymentHistory[]
  feedbacks    Feedback[]
  clients    Client[]
  suppliers  Supplier[]
  invoices   Invoice[]

  initialBalance Float @default(0) 
  initialSavings Float @default(0) 
  
  // Trial period
  trialEndsAt    DateTime?
  hasUsedTrial   Boolean  @default(false)

  @@map("users")
}

model BusinessProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String
  companyId   String?  // H.P. / Osek Murshe
  vatStatus   String   // EXEMPT (Ptor), AUTHORIZED (Murshe), LTD (Baam)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("business_profiles")
}

// ... (previous enums)

enum BudgetType {
  PERSONAL
  BUSINESS
}

// ... (User/BusinessProfile models remain same)

model Budget {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month     Int      
  year      Int      
  type      BudgetType @default(PERSONAL) // NEW: Supports separating Personal/Business budgets
  currency  String   @default("₪")
  incomes   Income[]
  expenses  Expense[]
  bills     Bill[]
  debts     Debt[]
  savings   Saving[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // CHANGED: Unique constraint now includes 'type' to allow 2 budgets per month (Personal + Business)
  @@unique([userId, month, year, type])
  @@index([userId, month, year])
  @@map("budgets")
}

model Category {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  type      String   // income, expense, saving
  scope     BudgetType @default(PERSONAL) // NEW: Category belongs to Personal or Business view
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("categories")
}

// ... (Rest of models)


// SMB Enums
enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  BIT
  OTHER
}

enum ExpenseType {
  OPEX // Operational Expenditure
  CAPEX // Capital Expenditure (Assets)
}

model Income {
  id                String   @id @default(cuid())
  budgetId          String
  budget            Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  source            String
  category          String   @default("כללי")
  amount            Float
  date              DateTime?
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?
  
  // Business Fields
  clientId          String?
  client            Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  invoiceId         String?
  invoice           Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  amountBeforeVat   Float?
  vatRate           Float?   @default(0) // 0.17 etc.
  vatAmount         Float?
  invoiceDate       DateTime? // Tax event date
  paymentDate       DateTime? // Cash flow date (actual payment)
  paymentMethod     PaymentMethod?
  paymentTerms      Int?     @default(0)
  currency          String   @default("ILS")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@index([budgetId])
  @@index([clientId])
  @@map("incomes")
}

model Expense {
  id                String   @id @default(cuid())
  budgetId          String
  budget            Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category          String
  amount            Float
  currency          String   @default("ILS")
  description       String?
  date              DateTime?
  installments      Int      @default(1)
  currentInstallment Int     @default(1)
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?
  
  // Business Fields
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  amountBeforeVat   Float?
  vatRate           Float?   @default(0) // 0.17 etc.
  vatAmount         Float?
  vatType           VatType? @default(FULL)
  isDeductible      Boolean? @default(true) // For income tax recognition
  deductibleRate    Float?   @default(1.0) // 1.0 = 100%, 0.45 = 45% etc.
  expenseType       ExpenseType? @default(OPEX)
  invoiceDate       DateTime? // Tax event date
  paymentDate       DateTime? // Cash flow date
  paymentMethod     PaymentMethod?
  paymentTerms      Int?     @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@index([budgetId])
  @@index([budgetId, category])
  @@index([supplierId])
  @@map("expenses")
}

model Bill {
  id          String   @id @default(cuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  name        String
  amount      Float
  currency    String   @default("ILS")
  dueDate     DateTime @default(now())
  isPaid      Boolean  @default(false)
  category    String   @default("חשבונות")
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  paidDate            DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([budgetId])
  @@index([budgetId, isPaid])
  @@map("bills")
}

model Debt {
  id              String    @id @default(cuid())
  budgetId        String
  budget          Budget    @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  creditor        String
  debtType        String    // owed_by_me, owed_to_me
  totalAmount     Float
  currency        String    @default("ILS")
  monthlyPayment  Float
  dueDay          Int
  isPaid          Boolean   @default(false)
  isRecurring     Boolean   @default(false)
  recurringSourceId String?
  totalDebtAmount Float?    // For installments tracking
  numberOfInstallments Int?
  installmentNumber Int?
  paidDate        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@index([budgetId])
  @@index([budgetId, isPaid])
  @@map("debts")
}

model Saving {
  id              String    @id @default(cuid())
  budgetId        String?
  budget          Budget?   @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  name            String    @default("חסכון")
  targetAmount    Float?
  currentAmount   Float     @default(0)
  currency        String    @default("ILS")
  monthlyDeposit  Float?    // Planned monthly contribution
  targetDate      DateTime?
  category        String    @default("חסכון") // e.g., Emergency Fund, Vacation
  color           String?   // UI color integration
  notes           String?
  
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@map("savings")
}

model Subscription {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status            String    @default("inactive") // trial, active, expired, inactive
  planType          PlanType  @default(PERSONAL)   // NEW: PERSONAL vs BUSINESS
  couponCode        String?   // Tracks which coupon was used (for Admin display)
  startDate         DateTime  @default(now())
  endDate           DateTime?
  paypalOrderId     String?
  lastPaymentDate   DateTime?
  lastPaymentAmount Float?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  expiryNotified30Days Boolean @default(false)
  expiryNotified7Days  Boolean @default(false)
  deletionScheduledFor DateTime?
  
  @@unique([userId, planType]) // CHANGED: Allow one subscription per plan type
  @@map("subscriptions")
}

model PaymentHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  currency      String   @default("ILS")
  status        String   // completed, failed, pending
  paypalOrderId String?
  createdAt     DateTime @default(now())
  @@map("payment_history")
}

model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique
  discountPercent Float
  expiryDate      DateTime?
  maxUses         Int?
  usedCount       Int       @default(0)
  specificEmail   String?   // Optional: restrict to specific user email
  planType        PlanType? // Optional: restrict to specific plan (PERSONAL/BUSINESS)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@map("coupons")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())
  
  @@map("feedbacks")
}

model TrialTracker {
  id        String   @id @default(cuid())
  email     String
  planType  PlanType @default(PERSONAL)
  createdAt DateTime @default(now())

  @@unique([email, planType])
  @@map("trial_trackers")
}

model SiteConfig {
  id              String   @id @default("default")
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt

  @@map("site_config")
}

model AIAdviceCache {
  id        String   @id @default(cuid())
  userId    String
  month     Int
  year      Int
  advice    String   @db.Text
  createdAt DateTime @default(now())
  expiresAt DateTime
  
  @@unique([userId, month, year])
  @@index([userId, expiresAt])
  @@map("ai_advice_cache")
}

model SiteSettings {
  id              String   @id @default("site_settings")
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt
  
  @@map("site_settings")
}

// Business Models

model Client {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Client details
  name      String
  email     String?
  phone     String?
  taxId     String?  // ח.פ / ע.מ
  address   String?
  notes     String?  @db.Text
  
  // Metadata
  scope     String   @default("BUSINESS")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  incomes   Income[]
  invoices  Invoice[]
  
  @@index([userId, scope])
  @@unique([userId, name, scope])
  @@map("clients")
}

model Supplier {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Supplier details
  name      String
  email     String?
  phone     String?
  taxId     String?  // ח.פ / ע.מ
  address   String?
  notes     String?  @db.Text
  
  // Metadata
  scope     String   @default("BUSINESS")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  expenses  Expense[]
  
  @@index([userId, scope])
  @@unique([userId, name, scope])
  @@map("suppliers")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Invoice details
  invoiceNumber String
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  status        InvoiceStatus @default(DRAFT)
  
  // Amounts
  subtotal      Float
  vatRate       Float         @default(0.17)
  vatAmount     Float
  total         Float
  currency      String        @default("ILS")
  
  // Payment
  paidDate      DateTime?
  paidAmount    Float?
  
  // Notes
  notes         String?       @db.Text
  
  // Metadata
  scope         String        @default("BUSINESS")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  incomes       Income[]
  
  @@index([userId, scope])
  @@index([clientId])
  @@unique([userId, invoiceNumber])
  @@map("invoices")
}
