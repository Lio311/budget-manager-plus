generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// Enums for Business Support
enum PlanType {
  PERSONAL
  BUSINESS
}

enum VatType {
  NONE            // Ptor (Eilat etc.)
  FULL            // 100% recognized
  PARTIAL         // 2/3 or other %
  EXEMPT          // Frugality, etc.
}

model User {
  id        String   @id 
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
   
  budgets    Budget[]
  categories Category[]
  subscription Subscription?
  businessProfile BusinessProfile?
  paymentHistory PaymentHistory[]
  feedbacks    Feedback[]

  initialBalance Float @default(0) 
  initialSavings Float @default(0) 
  
  // Trial period
  trialEndsAt    DateTime?
  hasUsedTrial   Boolean  @default(false)

  @@map("users")
}

model BusinessProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String
  companyId   String?  // H.P. / Osek Murshe
  vatStatus   String   // EXEMPT (Ptor), AUTHORIZED (Murshe), LTD (Baam)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("business_profiles")
}

model Budget {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month     Int      
  year      Int      
  currency  String   @default("₪")
  incomes   Income[]
  expenses  Expense[]
  bills     Bill[]
  debts     Debt[]
  savings   Saving[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, month, year])
  @@index([userId, month, year])
  @@map("budgets")
}

model Category {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  type      String   // income, expense, saving
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("categories")
}

model Income {
  id                String   @id @default(cuid())
  budgetId          String
  budget            Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  source            String
  category          String   @default("כללי")
  amount            Float
  date              DateTime?
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?
  
  // Business Fields
  amountBeforeVat   Float?
  vatAmount         Float?
  invoiceDate       DateTime? // Tax event date
  paymentDate       DateTime? // Cash flow date
  paymentMethod     String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@index([budgetId])
  @@map("incomes")
}

model Expense {
  id                String   @id @default(cuid())
  budgetId          String
  budget            Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category          String
  amount            Float
  description       String?
  date              DateTime?
  installments      Int      @default(1)
  currentInstallment Int     @default(1)
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  recurringStartDate  DateTime?
  recurringEndDate    DateTime?
  
  // Business Fields
  amountBeforeVat   Float?
  vatAmount         Float?
  vatType           VatType? @default(FULL)
  isDeductible      Boolean? @default(true) // For income tax recognition
  invoiceDate       DateTime? // Tax event date
  paymentDate       DateTime? // Cash flow date
  paymentMethod     String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@index([budgetId])
  @@index([budgetId, category])
  @@map("expenses")
}

model Bill {
  id          String   @id @default(cuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  name        String
  amount      Float
  dueDate     DateTime @default(now())
  isPaid      Boolean  @default(false)
  category    String   @default("חשבונות")
  isRecurring         Boolean  @default(false)
  recurringSourceId   String?
  paidDate            DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([budgetId])
  @@index([budgetId, isPaid])
  @@map("bills")
}

model Debt {
  id              String    @id @default(cuid())
  budgetId        String
  budget          Budget    @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  creditor        String
  debtType        String    // owed_by_me, owed_to_me
  totalAmount     Float
  monthlyPayment  Float
  dueDay          Int
  isPaid          Boolean   @default(false)
  isRecurring     Boolean   @default(false)
  recurringSourceId String?
  totalDebtAmount Float?    // For installments tracking
  numberOfInstallments Int?
  installmentNumber Int?
  paidDate        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@index([budgetId])
  @@index([budgetId, isPaid])
  @@map("debts")
}

model Saving {
  id              String    @id @default(cuid())
  budgetId        String?
  budget          Budget?   @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  name            String    @default("חסכון")
  targetAmount    Float?
  currentAmount   Float     @default(0)
  monthlyDeposit  Float?    // Planned monthly contribution
  targetDate      DateTime?
  category        String    @default("חסכון") // e.g., Emergency Fund, Vacation
  color           String?   // UI color integration
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@map("savings")
}

model Subscription {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status            String    @default("inactive") // trial, active, expired, inactive
  planType          PlanType  @default(PERSONAL)   // NEW: PERSONAL vs BUSINESS
  startDate         DateTime  @default(now())
  endDate           DateTime?
  paypalOrderId     String?
  lastPaymentDate   DateTime?
  lastPaymentAmount Float?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  expiryNotified30Days Boolean @default(false)
  expiryNotified7Days  Boolean @default(false)
  deletionScheduledFor DateTime?
  @@map("subscriptions")
}

model PaymentHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  currency      String   @default("ILS")
  status        String   // completed, failed, pending
  paypalOrderId String?
  createdAt     DateTime @default(now())
  @@map("payment_history")
}

model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique
  discountPercent Float
  expiryDate      DateTime?
  maxUses         Int?
  usedCount       Int       @default(0)
  specificEmail   String?   // Optional: restrict to specific user email
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@map("coupons")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())
  
  @@map("feedbacks")
}

model TrialTracker {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())

  @@map("trial_trackers")
}

model AIAdviceCache {
  id        String   @id @default(cuid())
  userId    String
  month     Int
  year      Int
  advice    String   @db.Text
  createdAt DateTime @default(now())
  expiresAt DateTime
  
  @@unique([userId, month, year])
  @@index([userId, expiresAt])
  @@map("ai_advice_cache")
}
